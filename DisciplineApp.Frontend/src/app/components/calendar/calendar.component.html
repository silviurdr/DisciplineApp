
  <div *ngIf="loading" class="loading-state">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <h3>Loading your discipline dashboard...</h3>
      <p>Preparing tasks and sub-habits</p>
    </div>
  </div>
<div *ngIf="!loading" class="calendar-container">
  <!-- Header with Progress -->
  <div class="header" *ngIf="weekData">
    <div class="header-content">
      <div class="app-title-section">
        <div class="week-info">
          {{ getCurrentWeekRange() }}
        </div>
      </div>

      <div class="progress-overview">
        <div class="week-progress">
          <div class="progress-header">
            <h3 class="progress-title">Week Progress</h3>
            <div class="progress-percentage">{{ getWeekProgressPercentage() }}%</div>
          </div>
          <div class="progress-bar-container">
            <div class="progress-bar" [style.width.%]="getWeekProgressPercentage()"></div>
          </div>
        </div>

        <div class="grace-info" *ngIf="weekData.weeklyStats">
          <div class="grace-icon">‚ú®</div>
          <div class="grace-count">{{ weekData.weeklyStats.graceRemaining }}/{{ weekData.weeklyStats.graceRemaining + weekData.weeklyStats.graceUsed }}</div>
          <div class="grace-label">Grace Days</div>
        </div>
      </div>
    </div>
  </div>


  <!-- Weekly Habit Summary -->
<div class="weekly-overview" *ngIf="calculateWeeklyHabitProgress().length > 0">
  <div class="habit-summary">
    <!-- Habit Progress Cards with Advanced Complete buttons -->
    <div *ngFor="let habit of calculateWeeklyHabitProgress()"
        class="habit-progress"
        [class.status-unachievable]="!habit.isAchievable && habit.percentage < 100"
        [class.status-completed]="habit.percentage === 100"
        [class.status-in-progress]="habit.isAchievable && habit.percentage > 0 && habit.percentage < 100"
        [class.status-not-started]="habit.isAchievable && habit.percentage === 0">
      
      <!-- Habit Info Section -->
      <div class="habit-info">
        <span class="habit-name">{{ habit.habitName }}</span>
        <div class="habit-stats">
          <span class="habit-count">{{ habit.completed }}/{{ habit.total }}</span>
          <span class="habit-percentage">({{ habit.percentage }}%)</span>
        </div>
      </div>

      <!-- Advanced Complete Button Section -->
      <div class="habit-actions" *ngIf="canShowAdvancedComplete(habit)">
   <button *ngIf="canShowAdvancedComplete(habit)" 
              class="advance-complete-btn"
              [disabled]="isAdvancedCompleting === getHabitIdFromNameForTemplate(habit.habitName)"
              (click)="advancedCompleteTask(habit)"
              [title]="'Complete ' + habit.habitName + ' now'">
        <span *ngIf="isAdvancedCompleting !== getHabitIdFromNameForTemplate(habit.habitName)">‚è≠Ô∏è</span>
        <span *ngIf="isAdvancedCompleting === getHabitIdFromNameForTemplate(habit.habitName)" class="loading">‚ãØ</span>
      </button>
      </div>
    </div>

    <!-- Time Stats Card (preserve existing structure) -->
    <div class="time-stats-card">
      <div class="time-content">
        <span class="time-icon">‚è±Ô∏è</span>
        <div class="time-info">
          <div class="time-title">Weekly Time</div>
          <div class="time-progress">
            <span class="completed-time">{{ formatHours(getWeekCompletedHours() * 60) }}</span>
            <span class="time-separator">/</span>
            <span class="total-time">{{ formatHours(getWeekTotalHours() * 60) }}</span>
          </div>
        </div>
      </div>
      <div class="time-percentage">({{ getTimeCompletionPercentage() }}%)</div>
    </div>
  </div>
</div>

  <!-- Weekly Calendar -->
  <div class="weekly-calendar" *ngIf="currentWeekDays && currentWeekDays.length > 0">
    <div class="calendar-week">
      <div *ngFor="let day of currentWeekDays" 
          class="calendar-day"
          [class.completed]="day.isCompleted"
          [class.partial]="day.isPartiallyCompleted && !day.isCompleted && isToday(day.date)"
          [class.today]="isToday(day.date)"
          [class.future]="isFuture(day.date)"
          [class.failed]="!isToday(day.date) && !isFuture(day.date) && !day.isCompleted"
          (click)="openDayDetail(day)">
        
        <div class="day-header">
          <div class="day-name">{{ getDayName(day.date) }}</div>
          <div class="day-number">{{ getDayNumber(day.date) }}</div>
        </div>

        <div class="day-content">
          <div class="completion-status">
            <span class="status-icon" 
                  [class.incomplete]="!day.isCompleted && !day.isPartiallyCompleted"
                  [class.partial]="day.isPartiallyCompleted && !day.isCompleted">
            {{ getCompletionIcon(day) }}
            </span>
          </div>

          <!-- ‚úÖ UPDATED: Use helper methods for accurate counters (required tasks only) -->
          <div class="progress-indicator" *ngIf="getRequiredTasksCount(day) > 0">
            <div class="progress-bar" [class.progress-completed]="day.isCompleted"
                 [class.progress-incomplete]="!day.isCompleted && !isToday(day.date)"
                 [class.progress-today]="isToday(day.date)">
              <div class="progress-fill" 
                   [style.width.%]="getRequiredTasksCount(day) > 0 ? (getCompletedRequiredTasksCount(day) / getRequiredTasksCount(day)) * 100 : 100">
              </div>
            </div>
            <!-- ‚úÖ Show required task progress only -->
            <div class="progress-text">
              {{ getCompletedRequiredTasksCount(day) }}/{{ getRequiredTasksCount(day) }}
            </div>
          </div>
          
          <!-- ‚úÖ OPTIONAL: Show when day has no required tasks but has optional tasks -->
          <div class="optional-only-indicator" 
               *ngIf="getRequiredTasksCount(day) === 0 && getTotalTasksCount(day) > 0">
            <div class="optional-text">Optional only</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Today Smart Schedule Section -->
  <div class="smart-schedule" *ngIf="todayData">
    <div class="schedule-header">
      <div class="header-left">
        <h2 class="schedule-title">
          <!-- ‚úÖ UPDATED: Show both required and total task counts -->
          Tasks ({{ getRequiredTasksCount(todayData) }} required, {{ getTotalTasksCount(todayData) }} total)
                  <span class="time-info">‚Ä¢ {{ formatHours(getTodayCompletedHours() * 60) }}/{{ formatHours(getTodayTotalHours() * 60) }}</span>

          <span class="today-label">Today</span>
        </h2>
      </div>
      
      <!-- Add Quick Task Button -->
      <button class="add-quick-task-btn" (click)="openAddTaskModal()" title="Add a quick task for today">
        <span class="plus-icon">+</span>
      </button>
    </div>

    <!-- ‚úÖ UPDATED: Day status message considering only required tasks -->
    <div class="day-status-message">
      <div *ngIf="getCompletedRequiredTasksCount(todayData) === getRequiredTasksCount(todayData) && getRequiredTasksCount(todayData) > 0" 
           class="completion-message success">
        üéâ All required tasks completed! Day is complete.
        <div class="optional-tasks" *ngIf="getTotalTasksCount(todayData) > getRequiredTasksCount(todayData)">
          Optional tasks remaining: {{ getTotalTasksCount(todayData) - getCompletedTotalTasksCount(todayData) }}
        </div>
      </div>
      
      <div *ngIf="getCompletedRequiredTasksCount(todayData) < getRequiredTasksCount(todayData) && getRequiredTasksCount(todayData) > 0"
           class="completion-message progress">
        {{ getCompletedRequiredTasksCount(todayData) }}/{{ getRequiredTasksCount(todayData) }} required tasks completed
      </div>

      <div *ngIf="getRequiredTasksCount(todayData) === 0 && getTotalTasksCount(todayData) > 0"
           class="completion-message optional-only">
        üåü No required tasks today - all tasks are optional!
      </div>
    </div>

    <!-- Compact Task List -->
<div class="task-list" *ngIf="todayData.allHabits && todayData.allHabits.length > 0">
      <div 
        *ngFor="let habit of todayData.allHabits | sortCompleted" 
        class="task-row"
        [class.completed]="habit.isCompleted"
        [class.urgent]="isUrgentTask(habit)"
        [class.locked]="habit.isLocked"
        [class.ad-hoc]="habit.isAdHoc"
        [class.overdue]="habit.isOverdue"
        [class.optional-task]="habit.priority === 'Optional'"
        [class.has-sub-habits]="habit.hasSubHabits">

        <!-- Main Habit Row -->
        <div class="main-task-row">
          <!-- Task Checkbox -->
          <div class="task-checkbox">
            <input 
              type="checkbox" 
              [id]="'task-' + (habit.habitId || habit.adHocId)"
              [checked]="habit.isCompleted" 
              [disabled]="habit.isLocked || habit.isCompleted || habit.isOverdue"
              (change)="toggleTask(habit)">
            <label [for]="'task-' + (habit.habitId || habit.adHocId)" class="checkbox-label">
              <svg class="checkmark-svg" viewBox="0 0 12 10">
                <polyline points="1.5 5.5 4.5 8.5 10.5 1.5"></polyline>
              </svg>
            </label>
          </div>

          <!-- Task Content -->
          <div class="task-content">
            <div class="task-header">
              <div class="task-name-wrapper">
                <span class="task-name" [class.completed-text]="habit.isCompleted">
                  {{ habit.name }}
                </span>
                
                <!-- Sub-habits indicator -->
                <span *ngIf="habit.hasSubHabits" class="sub-habits-indicator">
                  ({{ habit.completedSubHabitsCount }}/{{ habit.totalSubHabitsCount }})
                </span>
              </div>

              <!-- Expand/Collapse Button -->
              <button *ngIf="habit.hasSubHabits" 
                      class="expand-btn"
                      (click)="toggleHabitExpansion(habit.habitId)"
                      [class.expanded]="isHabitExpanded(habit.habitId)"
                      title="{{isHabitExpanded(habit.habitId) ? 'Collapse' : 'Expand'}} sub-habits">
                <span class="expand-icon">{{ isHabitExpanded(habit.habitId) ? '‚ñº' : '‚ñ∂' }}</span>
              </button>
            </div>
            
            <!-- Task Meta Info -->
            <div class="task-meta">
              <!-- Show "Must Do" for critical tasks -->
              <span *ngIf="habit.isMustDo && !habit.isCompleted" class="task-must-do">
                MUST DO
              </span>

              <!-- Show "Deferred" status -->
              <span *ngIf="habit.deferralsUsed && habit.deferralsUsed > 0" class="task-deferred">
                Deferred
              </span>

              <!-- Show OVERDUE chip for overdue tasks -->
              <span *ngIf="habit.isOverdue && !habit.isCompleted" 
                    class="task-overdue">
                OVERDUE
              </span>

              <!-- Show OPTIONAL priority with specific styling -->
              <span *ngIf="habit.priority && habit.priority === 'Optional'" 
                    class="task-priority optional">
                Optional
              </span>

                          <span *ngIf="getTaskDuration(habit)" 
                  class="task-duration"
                  [class.completed-duration]="habit.isCompleted">
              {{ getTaskDuration(habit) }}
            </span>

              <!-- Show frequency chip -->
              <span *ngIf="habit.frequency" 
                    class="task-frequency">
                {{ habit.frequency }}
              </span>

              <!-- Show deadline countdown (for tasks with time remaining) -->
              <span *ngIf="habit.timeRemaining && !habit.isCompleted && !habit.isOverdue" 
                    class="task-deadline"
                    [class.critical]="getUrgencyLevel(habit.timeRemaining) === 'critical'"
                    [class.urgent]="getUrgencyLevel(habit.timeRemaining) === 'urgent'"
                    [class.moderate]="getUrgencyLevel(habit.timeRemaining) === 'moderate'"
                    [class.normal]="getUrgencyLevel(habit.timeRemaining) === 'normal'">
                {{ habit.timeRemaining }}
              </span>

            </div>
                      <div class="task-actions">

            <!-- Edit button for ad-hoc tasks -->
            <button *ngIf="habit.isAdHoc" 
                    class="action-btn edit-btn" 
                    (click)="editAdHocTask(habit)"
                    title="Edit this task">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
              </svg>
            </button>

            <!-- Move task button for regular habits that allow deferrals -->
            <button *ngIf="!habit.isAdHoc && !habit.isCompleted && canActuallyMoveHabit(habit)" 
                    class="action-btn move-btn" 
                    (click)="moveTaskToTomorrow(habit)"
                    [title]="getMoveButtonTooltip(habit)">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                <path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/>
              </svg>
            </button>
          </div>
          </div>

          <!-- Task Actions -->
        </div>

        <!-- Sub-Habits Section (Collapsible) -->
        <div *ngIf="habit.hasSubHabits && isHabitExpanded(habit.habitId)" 
             class="sub-habits-section">
          
          <div class="sub-habits-header">
            <h4>Sub-Tasks</h4>
            <span class="sub-habits-progress">
              {{ habit.completedSubHabitsCount }}/{{ habit.totalSubHabitsCount }} completed
            </span>
                <button type="button"  class="action-btn quick-complete-btn" 
                    (click)="quickCompleteAllSubHabits(habit.habitId)"
                    title="Complete all sub-habits at once">
              <span class="quick-complete-icon">‚úì</span>
              <span class="quick-complete-text">Complete All</span>
            </button>
          </div>

          <div class="sub-habits-list">
            <div *ngFor="let subHabit of habit.subHabits" 
                 class="sub-habit-item"
                 [class.completed]="subHabit.isCompleted">
              
              <!-- Sub-habit Checkbox -->
              <div class="sub-habit-checkbox">
                <input type="checkbox" 
                       [id]="'sub-habit-' + subHabit.id"
                       [checked]="subHabit.isCompleted" 
                       [disabled]="habit.isCompleted || subHabit.isCompleted"
                       (change)="toggleSubHabitCompletion(subHabit.id, !subHabit.isCompleted)">
                <label [for]="'sub-habit-' + subHabit.id" [class.disabled]="habit.isCompleted || subHabit.isCompleted" class="checkbox-label"></label>
              </div>

              <!-- Sub-habit Content -->
              <div class="sub-habit-content">
                <div class="sub-habit-name">{{ subHabit.name }}</div>
                <div *ngIf="subHabit.description" class="sub-habit-description">
                  {{ subHabit.description }}
                </div>
                <div *ngIf="subHabit.isCompleted && subHabit.completedAt" class="sub-habit-completed-at">
                  Completed at {{ subHabit.completedAt | date:'short' }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- No Tasks State -->
    <div class="no-tasks" *ngIf="!todayData.allHabits || todayData.allHabits.length === 0">
      <div class="no-tasks-icon">üéØ</div>
      <h3>No tasks scheduled</h3>
      <p>Enjoy your free time!</p>
    </div>

  <!-- Loading State -->
  <div class="loading-state" *ngIf="loading">
    <div class="loading-spinner"></div>
    <p>Loading your discipline calendar...</p>
  </div>

  <!-- Error State -->
  <div class="error-state" *ngIf="error">
    <div class="error-icon">‚ö†Ô∏è</div>
    <h3>Something went wrong</h3>
    <p>{{ error }}</p>
    <button class="retry-button" (click)="loadCurrentWeekData()">
      Try Again
    </button>
  </div>

  <!-- Add Task Modal -->
<!-- Add Task Modal -->
<div class="modal-overlay" *ngIf="showAddTaskDialog" (click)="cancelAddTask()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Add Quick Task</h3>
      <button class="close-btn" (click)="cancelAddTask()">√ó</button>
    </div>
    
    <div class="modal-body">
      <div class="form-group">
        <label for="taskName">Task Name *</label>
        <input 
          type="text" 
          id="taskName"
          [(ngModel)]="newTaskName" 
          placeholder="Enter task name (e.g., 'Take out trash')"
          maxlength="100"
          class="form-input"
          #taskNameInput>
      </div>
      
      <div class="form-group">
        <label for="taskDescription">Description (optional)</label>
        <textarea 
          id="taskDescription"
          [(ngModel)]="newTaskDescription" 
          placeholder="Add any additional details..."
          maxlength="500"
          rows="3"
          class="form-textarea"></textarea>
      </div>

      <div class="form-group">
        <label class="checkbox-label">
          <input type="checkbox" [(ngModel)]="hasDeadline" name="hasDeadline">
          Set deadline for this task
        </label>
        <!-- ‚úÖ NEW: Informative text about default deadline -->
        <div class="form-hint" *ngIf="!hasDeadline">
          <span class="hint-icon">üí°</span>
          <span class="hint-text">If no deadline is set, this task will be due today</span>
        </div>
      </div>

      <div class="form-group" *ngIf="hasDeadline">
        <label for="deadlineDate">Deadline Date</label>
        <input type="date" 
              id="deadlineDate"
              [(ngModel)]="deadlineDate"
              name="deadlineDate"
              [min]="getTodayDateString()"
              placeholder="Select deadline date">
      </div>

          <div class="form-group">
      <label for="newTaskDuration">Estimated Duration (minutes)</label>
      <input 
        type="number" 
        id="newTaskDuration"
        [(ngModel)]="newTaskEstimatedDuration" 
        placeholder="Enter estimated duration..."
        min="0"
        max="480"
        class="form-input">
    </div>
      
      <div class="error-message" *ngIf="errorMessage">
        {{ errorMessage }}
      </div>
    </div>
    
    <div class="modal-footer">
      <button class="cancel-btn" (click)="cancelAddTask()">Cancel</button>
      <button class="save-btn" (click)="addAdHocTask()" [disabled]="!newTaskName.trim()">
        Add Task
      </button>
    </div>
  </div>
</div>

  <!-- Edit Task Modal -->
  <div class="modal-overlay" *ngIf="showEditTaskDialog" (click)="cancelEditTask()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Edit Task</h3>
        <button class="close-btn" (click)="cancelEditTask()">√ó</button>
      </div>
      
      <div class="modal-body">
        <div class="form-group">
          <label for="editTaskName">Task Name *</label>
          <input 
            type="text" 
            id="editTaskName"
            [(ngModel)]="editTaskName" 
            placeholder="Enter task name"
            maxlength="100"
            class="form-input">
        </div>
        
        <div class="form-group">
          <label for="editTaskDescription">Description (optional)</label>
          <textarea 
            id="editTaskDescription"
            [(ngModel)]="editTaskDescription" 
            placeholder="Add any additional details..."
            maxlength="500"
            rows="3"
            class="form-textarea"></textarea>
        </div>

            <div class="form-group">
      <label for="editTaskDuration">Estimated Duration (minutes)</label>
      <input 
        type="number" 
        id="editTaskDuration"
        [(ngModel)]="editTaskEstimatedDuration" 
        placeholder="Enter estimated duration..."
        min="0"
        max="480"
        class="form-input">
    </div>
        
        <div class="error-message" *ngIf="errorMessage">
          {{ errorMessage }}
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="cancel-btn" (click)="cancelEditTask()">Cancel</button>
        <button class="save-btn" (click)="saveEditedTask()" [disabled]="!editTaskName.trim()">
          Save Changes
        </button>
      </div>
    </div>
  </div>
</div>
