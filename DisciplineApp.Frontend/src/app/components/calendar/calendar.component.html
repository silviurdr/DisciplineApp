<div class="calendar-container">
  <!-- Header -->
  <div class="header">
    <h1 class="title">Discipline Calendar</h1>
    <div class="week-title" *ngIf="weekData">
      Current Week: {{ weekData.weekStartDate | date:'MMMM d' }} - {{ weekData.weekEndDate | date:'d, y' }}
    </div>
  </div>

  <!-- Weekly Progress Overview -->
<!-- Weekly Progress Overview -->
<div class="weekly-overview" *ngIf="weeklyProgress">
  <div class="progress-card">
    <h3>Week Progress: {{ calculateWeekProgress() }}%</h3>
    <div class="grace-info">
      <span class="grace-remaining">Grace Days: {{ weeklyProgress.graceRemaining }}/1</span>
      <span class="grace-used" *ngIf="weeklyProgress.graceUsed > 0">Used: {{ weeklyProgress.graceUsed }}</span>
    </div>
  </div>
  
  <!-- Individual Habit Progress Summary -->
  <div class="habit-summary">
    <div *ngFor="let habit of calculateWeeklyHabitProgress()"
         class="habit-progress"
         [class.on-track]="habit.percentage >= 50"
         [class.behind]="habit.percentage < 50">
      <span class="habit-name">{{ habit.habitName }}</span>
      <span class="habit-count">{{ habit.completed }}/{{ habit.total }}</span>
      <span class="habit-percentage">({{ habit.percentage }}%)</span>
    </div>
  </div>
</div>

  <!-- Weekly Calendar Grid -->
  <div class="weekly-calendar" *ngIf="currentWeekDays && currentWeekDays.length > 0">
    <div class="calendar-week">
      <div *ngFor="let day of currentWeekDays" 
           class="calendar-day"
           [class.completed]="day.isCompleted"
           [class.partial]="day.isPartiallyCompleted && !day.isCompleted"
           [class.today]="isToday(day.date)"
           [class.previous-day]="!isToday(day.date)"
           [class.future]="isFuture(day.date)"
           (click)="openDayDetail(day)">
        
        <div class="day-header">
          <div class="day-name">{{ getDayName(day.date) }}</div>
          <div class="day-number">{{ getDayNumber(day.date) }}</div>
        </div>

        <div class="day-content">
          <div class="completion-status">
            <span class="status-icon" 
                  [class.incomplete]="!day.isCompleted && !day.isPartiallyCompleted"
                  [class.partial]="day.isPartiallyCompleted && !day.isCompleted">
              {{ getCompletionIcon(day) }}
            </span>
          </div>

          <div class="progress-indicator" *ngIf="day.totalHabits > 0">
            <div class="progress-bar">
              <div class="progress-fill" 
                   [style.width.%]="getCompletionPercentage(day)">
              </div>
            </div>
            <div class="progress-text">
              {{ day.completedHabits || 0 }}/{{ day.totalHabits }}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<!-- Today Smart Schedule Section -->
<div class="smart-schedule" *ngIf="todayData">
 <div class="schedule-header">
    <div class="header-left">
      <h2>üìÖ Today's Schedule</h2>
      
      <!-- Inline Stats moved here -->
      <div class="inline-stats">
        <div class="stat-chip required">
          <span class="stat-value">{{ getRequiredTasksCompleted(todayData) }}/{{ getRequiredTasksTotal(todayData) }}</span>
          <span class="stat-label">Required</span>
        </div>
        <div class="stat-chip optional">
          <span class="stat-value">{{ getOptionalTasksCompleted(todayData) }}/{{ getOptionalTasksTotal(todayData) }}</span>
          <span class="stat-label">Optional</span>
        </div>
        <div class="stat-chip grace" *ngIf="todayData.canUseGrace">
          <span class="stat-value">‚ú®</span>
          <span class="stat-label">Grace</span>
        </div>
      </div>
    </div>
    
    <!-- Add Quick Task Button (moved to right side) -->
    <button class="add-quick-task-btn" (click)="openAddTaskModal()" title="Add a quick task for today">
      <span class="plus-icon">+</span>
      <span class="btn-text">Quick Task</span>
    </button>
  </div>

  <!-- Compact Task List -->
  <div class="task-grid" *ngIf="todayData.allHabits && todayData.allHabits.length > 0">
    <div 
      *ngFor="let habit of todayData.allHabits | sortCompleted" 
      class="task-card"
      [class.completed]="habit.isCompleted"
      [class.urgent]="isUrgentTask(habit)"
      [class.locked]="habit.isLocked"
      [class.ad-hoc]="habit.isAdHoc"
      [class.overdue]="habit.isOverdue">
      
      <!-- Task Checkbox -->
      <div class="task-checkbox">
        <input 
          type="checkbox" 
          [id]="'task-' + (habit.habitId || habit.adHocId)"
          [checked]="habit.isCompleted" 
          [disabled]="habit.isLocked || (habit.isAdHoc && habit.isCompleted)"
          (change)="toggleTask(habit)">
        <label [for]="'task-' + (habit.habitId || habit.adHocId)" class="checkmark"></label>
      </div>

      <!-- Task Content -->
      <div class="task-content" (click)="!habit.isLocked && toggleTask(habit)">
        <div class="task-main">
          <h4 class="task-name" [class.completed-text]="habit.isCompleted">
            {{ habit.name }}
          </h4>
          
          <!-- Task Badges -->
          <div class="task-badges">
            <span *ngIf="habit.isRequired" class="badge required">Required</span>
            <span *ngIf="habit.isAdHoc" class="badge ad-hoc">Quick Task</span>
            <span *ngIf="habit.priority && habit.priority !== 'Normal'" 
                  class="badge priority" 
                  [class.critical]="habit.priority === 'Critical'"
                  [class.urgent]="habit.priority === 'Urgent'">
              {{ habit.priority }}
            </span>
            <span *ngIf="habit.isOverdue" class="badge overdue">Overdue</span>
          </div>
        </div>

        <!-- Task Description (if exists) -->
        <p *ngIf="habit.description" class="task-description">{{ habit.description }}</p>

        <!-- Time Remaining Badge -->
        <div *ngIf="habit.hasDeadline && habit.timeRemaining && !habit.isCompleted" 
             class="time-remaining"
             [class.critical]="getUrgencyLevel(habit.timeRemaining) === 'critical'"
             [class.urgent]="getUrgencyLevel(habit.timeRemaining) === 'urgent'">
          ‚è∞ {{ habit.timeRemaining }} left
        </div>
      </div>

      <!-- Quick Actions -->
<div class="task-actions" *ngIf="!habit.isLocked">
  <!-- Move to Tomorrow Button with Deferral Info -->
  <button 
    *ngIf="!isDailyHabit(habit) && !habit.isCompleted" 
    class="action-btn defer-btn"
    [class.disabled]="!canActuallyMoveHabit(habit)"
    (click)="moveTaskToTomorrow(habit)"
    [disabled]="habit.isCompleted || !canActuallyMoveHabit(habit)"
    [title]="getMoveButtonTooltip(habit)">
    ‚û°Ô∏è
  </button>
  
  <!-- Deferral Label -->
  <div *ngIf="!isDailyHabit(habit) && !habit.isCompleted && getFlexibilityInfo(habit) as flexInfo" 
       class="deferral-label"
       [class.safe]="flexInfo.urgency === 'safe'"
       [class.warning]="flexInfo.urgency === 'warning'" 
       [class.critical]="flexInfo.urgency === 'critical'"
       [title]="flexInfo.statusText">
    {{ flexInfo.icon }} {{ flexInfo.label }}
  </div>
  
  <!-- Edit Button - Only for ad-hoc tasks and only when not completed -->
  <button 
    *ngIf="habit.isAdHoc && !habit.isCompleted" 
    class="action-btn edit-btn"
    (click)="editAdHocTask(habit)"
    [disabled]="habit.isCompleted"
    title="Edit task">
    ‚úèÔ∏è
  </button>
</div>
    </div>
  </div>

  <!-- No Tasks Message -->
  <div *ngIf="!todayData.allHabits || todayData.allHabits.length === 0" class="no-tasks">
    <div class="no-tasks-icon">üéâ</div>
    <h3>All caught up!</h3>
    <p>No scheduled tasks for today. Enjoy your free time!</p>
  </div>

  <!-- Recommendations -->
  <div *ngIf="todayData.recommendations && todayData.recommendations.length > 0" class="recommendations">
    <h4>üí° Smart Suggestions</h4>
    <ul class="recommendation-list">
      <li *ngFor="let recommendation of todayData.recommendations" class="recommendation-item">
        {{ recommendation }}
      </li>
    </ul>
  </div>
</div>

  <!-- Loading State -->
  <div class="loading-state" *ngIf="loading">
    <div class="loading-spinner"></div>
    <p>Loading your discipline calendar...</p>
  </div>

  <!-- Error State -->
  <div class="error-state" *ngIf="error">
    <div class="error-icon">‚ö†Ô∏è</div>
    <h3>Something went wrong</h3>
    <p>{{ error }}</p>
    <button class="retry-button" (click)="loadCurrentWeekData()">
      Try Again
    </button>
  </div>

<!-- Debug Panel (for development) -->
<div class="debug-panel" *ngIf="false">
  <h4>Debug Info</h4>
  <pre>{{ { todayData, flexibleTasks, weeklyProgress } | json }}</pre>
</div>


<!-- Add Task Modal -->
<div class="modal-overlay" *ngIf="showAddTaskDialog" (click)="cancelAddTask()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Add Quick Task</h3>
      <button class="close-btn" (click)="cancelAddTask()">√ó</button>
    </div>
    
    <div class="modal-body">
      <div class="form-group">
        <label for="taskName">Task Name *</label>
        <input 
          type="text" 
          id="taskName"
          [(ngModel)]="newTaskName" 
          placeholder="Enter task name (e.g., 'Take out trash')"
          maxlength="100"
          class="form-input"
          #taskNameInput>
      </div>
      
      <div class="form-group">
        <label for="taskDescription">Description (optional)</label>
        <textarea 
          id="taskDescription"
          [(ngModel)]="newTaskDescription" 
          placeholder="Add any additional details..."
          maxlength="500"
          rows="3"
          class="form-textarea"></textarea>
      </div>
      
      <div class="error-message" *ngIf="errorMessage">
        {{ errorMessage }}
      </div>
    </div>
    
    <div class="modal-footer">
      <button class="cancel-btn" (click)="cancelAddTask()">Cancel</button>
      <button class="save-btn" (click)="addAdHocTask()" [disabled]="!newTaskName.trim()">
        Add Task
      </button>
    </div>
  </div>
</div>

<!-- Edit Task Modal -->
<div class="modal-overlay" *ngIf="showEditTaskDialog" (click)="cancelEditTask()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Edit Task</h3>
      <button class="close-btn" (click)="cancelEditTask()">√ó</button>
    </div>
    
    <div class="modal-body">
      <div class="form-group">
        <label for="editTaskName">Task Name *</label>
        <input 
          type="text" 
          id="editTaskName"
          [(ngModel)]="editTaskName" 
          placeholder="Enter task name"
          maxlength="100"
          class="form-input">
      </div>
      
      <div class="form-group">
        <label for="editTaskDescription">Description (optional)</label>
        <textarea 
          id="editTaskDescription"
          [(ngModel)]="editTaskDescription" 
          placeholder="Add any additional details..."
          maxlength="500"
          rows="3"
          class="form-textarea"></textarea>
      </div>
      
      <div class="error-message" *ngIf="errorMessage">
        {{ errorMessage }}
      </div>
    </div>
    
    <div class="modal-footer">
      <button class="cancel-btn" (click)="cancelEditTask()">Cancel</button>
      <button class="save-btn" (click)="saveEditedTask()" [disabled]="!editTaskName.trim()">
        Save Changes
      </button>
    </div>
  </div>
</div>