<div class="calendar-container">
  <!-- Header -->
  <div class="header">
    <div class="header-content">
      <!-- App Title Section -->
      <div class="app-title-section">
        <div class="week-info">Current Week: {{ getCurrentWeekRange() }}</div>
      </div>

      <!-- Progress Overview Only -->
      <div class="progress-overview">
        <div class="week-progress">
          <div class="progress-header">
            <h3 class="progress-title">Week Progress</h3>
            <div class="progress-percentage">{{ getWeekProgressPercentage() }}%</div>
          </div>
          <div class="progress-bar-container">
            <div class="progress-bar" [style.width.%]="getWeekProgressPercentage()"></div>
          </div>
        </div>

        <div class="grace-info" *ngIf="weeklyProgress">
          <span class="grace-icon">‚ú®</span>
          <div class="grace-count">{{ weeklyProgress.graceRemaining || 1 }}/{{ (weeklyProgress.graceUsed || 0) + (weeklyProgress.graceRemaining || 1) }}</div>
          <div class="grace-label">Grace Days</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Weekly Progress Overview -->
  <div class="weekly-overview" *ngIf="weeklyProgress">
    <div class="habit-summary">
      <div *ngFor="let habit of calculateWeeklyHabitProgress()"
          class="habit-progress"
          [class.status-unachievable]="!habit.isAchievable && habit.percentage < 100"
          [class.status-completed]="habit.percentage === 100"
          [class.status-in-progress]="habit.isAchievable && habit.percentage > 0 && habit.percentage < 100"
          [class.status-not-started]="habit.isAchievable && habit.percentage === 0">
        <span class="habit-name">{{ habit.habitName }}</span>
        <div class="habit-stats">
          <span class="habit-count">{{ habit.completed }}/{{ habit.total }}</span>
          <span class="habit-percentage">({{ habit.percentage }}%)</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Weekly Calendar Grid -->
  <div class="weekly-calendar" *ngIf="currentWeekDays && currentWeekDays.length > 0">
    <div class="calendar-week">
      <div *ngFor="let day of currentWeekDays" 
          class="calendar-day"
          [class.completed]="day.isCompleted"
          [class.partial]="day.isPartiallyCompleted && !day.isCompleted && isToday(day.date)"
          [class.today]="isToday(day.date)"
          [class.future]="isFuture(day.date)"
          [class.failed]="!isToday(day.date) && !isFuture(day.date) && !day.isCompleted"
          (click)="openDayDetail(day)">
        
        <div class="day-header">
          <div class="day-name">{{ getDayName(day.date) }}</div>
          <div class="day-number">{{ getDayNumber(day.date) }}</div>
        </div>

        <div class="day-content">
          <div class="completion-status">
            <span class="status-icon" 
                  [class.incomplete]="!day.isCompleted && !day.isPartiallyCompleted"
                  [class.partial]="day.isPartiallyCompleted && !day.isCompleted">
            {{ getCompletionIcon(day) }}
            </span>
          </div>

          <div class="progress-indicator" *ngIf="day.totalHabits > 0">
            <div class="progress-bar">
              <div class="progress-fill" 
                   [style.width.%]="getCompletionPercentage(day)">
              </div>
            </div>
            <div class="progress-text">
              {{ day.completedHabits || 0 }}/{{ day.totalHabits }}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Today Smart Schedule Section -->
  <div class="smart-schedule" *ngIf="todayData">
    <div class="schedule-header">
      <div class="header-left">
        <h2 class="schedule-title">
          Tasks({{ (todayData.allHabits && todayData.allHabits.length) || 0 }})
          <span class="today-label">Today</span>
        </h2>
      </div>
      
      <!-- Add Quick Task Button -->
      <button class="add-quick-task-btn" (click)="openAddTaskModal()" title="Add a quick task for today">
        <span class="plus-icon">+</span>
      </button>
    </div>

    <!-- Compact Task List -->
    <div class="task-list" *ngIf="todayData.allHabits && todayData.allHabits.length > 0">
      <div 
        *ngFor="let habit of todayData.allHabits | sortCompleted" 
        class="task-row"
        [class.completed]="habit.isCompleted"
        [class.urgent]="isUrgentTask(habit)"
        [class.locked]="habit.isLocked"
        [class.ad-hoc]="habit.isAdHoc"
        [class.overdue]="habit.isOverdue">
        
        <!-- Task Checkbox -->
        <div class="task-checkbox">
          <input 
            type="checkbox" 
            [id]="'task-' + (habit.habitId || habit.adHocId)"
            [checked]="habit.isCompleted" 
            [disabled]="habit.isLocked || habit.isCompleted"
            (change)="toggleTask(habit)">
          <label [for]="'task-' + (habit.habitId || habit.adHocId)" class="checkbox-label">
            <svg class="checkmark-svg" viewBox="0 0 12 10">
              <polyline points="1.5 5.5 4.5 8.5 10.5 1.5"></polyline>
            </svg>
          </label>
        </div>

        <!-- Task Content -->
        <div class="task-content">
          <span class="task-name" [class.completed-text]="habit.isCompleted">
            {{ habit.name }}
          </span>
          
          <!-- Task Meta Info -->
          <div class="task-meta">
            <span *ngIf="habit.isMustDo && !habit.isCompleted" class="task-must-do">
              100 %
            </span>

            <span *ngIf="habit.deferralsUsed ? habit.deferralsUsed > 0 : false" class="task-must-do">
              Deferred
            </span>

            <span *ngIf="habit.priority && habit.priority !== 'Normal'" 
                  class="task-priority"
                  [class.critical]="habit.priority === 'Critical'"
                  [class.urgent]="habit.priority === 'Urgent'"
                  [class.required]="habit.priority === 'Required'">
              {{ habit.priority }}
            </span>

            <span *ngIf="habit.frequency" class="task-frequency">
                {{ habit.frequency }}
              </span>

            <span *ngIf="habit.deadlineDate && !habit.isCompleted && habit.isAdHoc">{{habit.deadlineDate  | daysLeft  }} days left</span>
            <span *ngIf="habit.hasDeadline && habit.timeRemaining && !habit.isCompleted" 
                  class="task-time"
                  [class.time-critical]="getUrgencyLevel(habit.timeRemaining) === 'critical'">
              {{ habit.timeRemaining }}
            </span>
          </div>
        </div>

        <!-- Task Actions -->
        <div class="task-actions">
          <button 
            *ngIf="!isDailyHabit(habit) && !habit.isCompleted && !habit.isAdHoc" 
            class="action-btn move-btn"
            [class.disabled]="!canActuallyMoveHabit(habit)"
            (click)="moveTaskToTomorrow(habit)"
            [disabled]="habit.isCompleted || !canActuallyMoveHabit(habit)"
            [title]="getMoveButtonTooltip(habit)">
            <svg fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="16" height="16">
              <path d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
            </svg>
          </button>
          
          <button 
            *ngIf="habit.isAdHoc && !habit.isCompleted" 
            class="action-btn"
            (click)="editAdHocTask(habit)"
            [disabled]="habit.isCompleted"
            title="Edit task">
            <svg viewBox="0 0 20 20" width="16" height="16">
              <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- No Tasks Message -->
    <div *ngIf="!todayData.allHabits || todayData.allHabits.length === 0" class="no-tasks">
      <div class="no-tasks-icon">üéâ</div>
      <h3>All caught up!</h3>
      <p>No scheduled tasks for today. Enjoy your free time!</p>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-state" *ngIf="loading">
    <div class="loading-spinner"></div>
    <p>Loading your discipline calendar...</p>
  </div>

  <!-- Error State -->
  <div class="error-state" *ngIf="error">
    <div class="error-icon">‚ö†Ô∏è</div>
    <h3>Something went wrong</h3>
    <p>{{ error }}</p>
    <button class="retry-button" (click)="loadCurrentWeekData()">
      Try Again
    </button>
  </div>

  <!-- Add Task Modal -->
  <div class="modal-overlay" *ngIf="showAddTaskDialog" (click)="cancelAddTask()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Add Quick Task</h3>
        <button class="close-btn" (click)="cancelAddTask()">√ó</button>
      </div>
      
      <div class="modal-body">
        <div class="form-group">
          <label for="taskName">Task Name *</label>
          <input 
            type="text" 
            id="taskName"
            [(ngModel)]="newTaskName" 
            placeholder="Enter task name (e.g., 'Take out trash')"
            maxlength="100"
            class="form-input"
            #taskNameInput>
        </div>
        
        <div class="form-group">
          <label for="taskDescription">Description (optional)</label>
          <textarea 
            id="taskDescription"
            [(ngModel)]="newTaskDescription" 
            placeholder="Add any additional details..."
            maxlength="500"
            rows="3"
            class="form-textarea"></textarea>
        </div>

        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" [(ngModel)]="hasDeadline" name="hasDeadline">
            Set deadline for this task
          </label>
        </div>

        <div class="form-group" *ngIf="hasDeadline">
          <label for="deadlineDate">Deadline Date</label>
          <input type="date" 
                id="deadlineDate"
                [(ngModel)]="deadlineDate"
                name="deadlineDate"
                [min]="getTodayDateString()"
                placeholder="Select deadline date">
        </div>
        
        <div class="error-message" *ngIf="errorMessage">
          {{ errorMessage }}
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="cancel-btn" (click)="cancelAddTask()">Cancel</button>
        <button class="save-btn" (click)="addAdHocTask()" [disabled]="!newTaskName.trim()">
          Add Task
        </button>
      </div>
    </div>
  </div>

  <!-- Edit Task Modal -->
  <div class="modal-overlay" *ngIf="showEditTaskDialog" (click)="cancelEditTask()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Edit Task</h3>
        <button class="close-btn" (click)="cancelEditTask()">√ó</button>
      </div>
      
      <div class="modal-body">
        <div class="form-group">
          <label for="editTaskName">Task Name *</label>
          <input 
            type="text" 
            id="editTaskName"
            [(ngModel)]="editTaskName" 
            placeholder="Enter task name"
            maxlength="100"
            class="form-input">
        </div>
        
        <div class="form-group">
          <label for="editTaskDescription">Description (optional)</label>
          <textarea 
            id="editTaskDescription"
            [(ngModel)]="editTaskDescription" 
            placeholder="Add any additional details..."
            maxlength="500"
            rows="3"
            class="form-textarea"></textarea>
        </div>
        
        <div class="error-message" *ngIf="errorMessage">
          {{ errorMessage }}
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="cancel-btn" (click)="cancelEditTask()">Cancel</button>
        <button class="save-btn" (click)="saveEditedTask()" [disabled]="!editTaskName.trim()">
          Save Changes
        </button>
      </div>
    </div>
  </div>
</div>