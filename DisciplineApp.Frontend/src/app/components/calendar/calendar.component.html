<div class="calendar-container">
  <!-- Header -->
  <div class="header">
    <h1 class="title">Discipline Calendar</h1>
    <div class="week-title" *ngIf="weekData">
      Current Week: {{ weekData.weekStartDate | date:'MMMM d' }} - {{ weekData.weekEndDate | date:'d, y' }}
    </div>
  </div>

  <!-- Weekly Progress Overview -->
<!-- Weekly Progress Overview -->
<div class="weekly-overview" *ngIf="weeklyProgress">
  <div class="progress-card">
    <h3>Week Progress: {{ calculateWeekProgress() }}%</h3>
    <div class="grace-info">
      <span class="grace-remaining">Grace Days: {{ weeklyProgress.graceRemaining }}/1</span>
      <span class="grace-used" *ngIf="weeklyProgress.graceUsed > 0">Used: {{ weeklyProgress.graceUsed }}</span>
    </div>
  </div>
  
  <!-- Individual Habit Progress Summary -->
  <div class="habit-summary">
    <div *ngFor="let habit of calculateWeeklyHabitProgress()"
         class="habit-progress"
         [class.on-track]="habit.percentage >= 50"
         [class.behind]="habit.percentage < 50">
      <span class="habit-name">{{ habit.habitName }}</span>
      <span class="habit-count">{{ habit.completed }}/{{ habit.total }}</span>
      <span class="habit-percentage">({{ habit.percentage }}%)</span>
    </div>
  </div>
</div>

  <!-- Weekly Calendar Grid -->
  <div class="weekly-calendar" *ngIf="currentWeekDays && currentWeekDays.length > 0">
    <div class="calendar-week">
      <div *ngFor="let day of currentWeekDays" 
           class="calendar-day"
           [class.completed]="day.isCompleted"
           [class.partial]="day.isPartiallyCompleted && !day.isCompleted"
           [class.today]="isToday(day.date)"
           [class.previous-day]="!isToday(day.date)"
           [class.future]="isFuture(day.date)"
           (click)="openDayDetail(day)">
        
        <div class="day-header">
          <div class="day-name">{{ getDayName(day.date) }}</div>
          <div class="day-number">{{ getDayNumber(day.date) }}</div>
        </div>

        <div class="day-content">
          <div class="completion-status">
            <span class="status-icon" 
                  [class.incomplete]="!day.isCompleted && !day.isPartiallyCompleted"
                  [class.partial]="day.isPartiallyCompleted && !day.isCompleted">
              {{ getCompletionIcon(day) }}
            </span>
          </div>

          <div class="progress-indicator" *ngIf="day.totalHabits > 0">
            <div class="progress-bar">
              <div class="progress-fill" 
                   [style.width.%]="getCompletionPercentage(day)">
              </div>
            </div>
            <div class="progress-text">
              {{ day.completedHabits || 0 }}/{{ day.totalHabits }}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Today's Smart Schedule -->
  <div class="smart-schedule" *ngIf="isAnyToday() && todayData">
    <h2>Today's Smart Schedule</h2>

    <!-- Warnings Section -->
    <div class="warnings-section" *ngIf="todayData.warnings && todayData.warnings.length > 0">
      <div *ngFor="let warning of todayData.warnings" class="warning-item">
        <span class="warning-icon">‚ö†Ô∏è</span>
        <span>{{ warning }}</span>
      </div>
    </div>

    <!-- Grace Day Section -->
    <div class="grace-section" *ngIf="todayData.canUseGrace">
      <button class="grace-button" (click)="useGraceDay()">
        Use Grace Day ({{ weeklyProgress?.graceRemaining || 0 }} remaining)
      </button>
      <p class="grace-explanation">
        Skip today's habits without breaking your streak (1 per week)
      </p>
    </div>

    <!-- INTEGRATED SCHEDULED HABITS with Flexibility Features -->
    <div class="scheduled-habits" *ngIf="todayData.allHabits && todayData.allHabits.length > 0">
      <div class="habit-item" 
           *ngFor="let habit of todayData.allHabits | sortCompleted"
           [class]="getHabitClasses(habit)"
           [class.locked]="habit.isLocked">
        
        <!-- Habit Checkbox -->
        <div class="habit-checkbox">
          <input type="checkbox" 
                 [id]="'habit-' + habit.habitId + (habit.adHocId || '')"
                 [checked]="habit.isCompleted"
                 [disabled]="habit.isLocked || habit.isCompleted"
                 (change)="!habit.isLocked && toggleHabit(habit)">
          <label [for]="'habit-' + habit.habitId + (habit.adHocId || '')" 
                 [class.disabled]="habit.isLocked"></label>
        </div>
        
        <!-- Habit Content -->
        <div class="habit-content">
          <div class="habit-header">
            <div class="habit-name" [class.locked-text]="habit.isLocked">
              {{ habit.name }}
            </div>
            
            <!-- Enhanced Badges Section -->
            <div class="habit-badges">
              <!-- Priority Badge -->
              <span class="priority-badge" 
                    [class.required]="habit.isRequired" 
                    [class.optional]="!habit.isRequired">
                {{ habit.isRequired ? 'Required' : 'Optional' }}
              </span>
              
              <!-- NEW: Flexibility Badge - shows deferral status -->
              <span class="flexibility-badge" 
                    *ngIf="getFlexibilityInfo(habit) as flex"
                    [style.color]="flex.color"
                    [class]="'flexibility-' + flex.urgency">
                {{ flex.icon }} {{ flex.label }}
              </span>
              
              <!-- Time Remaining Badge -->
              <span class="time-remaining-badge" 
                    *ngIf="habit.hasDeadline && !habit.isCompleted && habit.timeRemaining"
                    [class.urgent]="getUrgencyLevel(habit.timeRemaining) === 'urgent'"
                    [class.critical]="getUrgencyLevel(habit.timeRemaining) === 'critical'">
                {{ habit.timeRemaining }}
              </span>
              
              <!-- Overdue Badge -->
              <span class="overdue-badge" *ngIf="habit.isOverdue">
                OVERDUE
              </span>
              
              <!-- Ad-Hoc Badge -->
              <span class="ad-hoc-badge" *ngIf="habit.isAdHoc">
                üìù Today Only
              </span>
              <span class="flexibility-badge" 
                *ngIf="getFlexibilityInfo(habit) as flexInfo"
                [style.color]="flexInfo.color"
                [class]="'flexibility-' + flexInfo.urgency">
                  {{ flexInfo.icon }} {{ flexInfo.label }}
                </span>
            </div>
          </div>
          
          <!-- Habit Description -->
          <div class="habit-description" *ngIf="habit.description">
            {{ habit.description }}
          </div>
          
          <!-- Habit Reason -->
          <div class="habit-reason" *ngIf="habit.reason">
            <em>{{ habit.reason }}</em>
          </div>
          
          <!-- NEW: Flexibility Status Display -->
<!-- Replace the problematic section with this corrected version -->

<!-- NEW: Flexibility Status Display -->
<div class="flexibility-status" 
     *ngIf="getFlexibilityInfo(habit) as flexInfo">
  <div class="flexibility-details" *ngIf="flexInfo.showDetails">
    <span class="flexibility-text" [style.color]="flexInfo.color">
      {{ flexInfo.statusText }}
    </span>
    <span class="deferrals-info" *ngIf="flexInfo.maxDeferrals > 0">
      ({{ flexInfo.remainingDeferrals }} of {{ flexInfo.maxDeferrals }} moves left)
    </span>
  </div>
  
  <!-- Progress Bar for Deferral Usage -->
  <div class="deferral-progress" *ngIf="flexInfo.maxDeferrals > 0">
    <div class="deferral-progress-bar">
      <div class="deferral-progress-fill" 
           [style.width.%]="(flexInfo.deferralsUsed / flexInfo.maxDeferrals) * 100"
           [style.background-color]="flexInfo.color">
      </div>
    </div>
  </div>
</div>
        
        <!-- Enhanced Actions Section -->
        <div class="habit-actions">
          <!-- Move to Tomorrow Button - Enhanced with Flexibility Logic -->
          <button class="move-tomorrow-btn" 
                  *ngIf="canMoveHabitToTomorrow(habit)"
                  [disabled]="!canActuallyMoveHabit(habit)"
                  [class.disabled]="!canActuallyMoveHabit(habit)"
                  (click)="moveHabitToTomorrow(habit)"
                  [title]="getMoveButtonTooltip(habit)">
            üìÖ {{ getMoveButtonText(habit) }}
          </button>
          
          <!-- Complete Button (for mobile/accessibility) -->
          <button class="complete-btn" 
                  *ngIf="!habit.isCompleted && !habit.isLocked"
                  (click)="toggleHabit(habit)"
                  [class.pulsing]="isUrgentTask(habit)">
            ‚úì Complete
          </button>
          
          <!-- Edit Ad-Hoc Button -->
          <button class="edit-btn" 
                  *ngIf="habit.isAdHoc"
                  (click)="editAdHocTask(habit)">
            ‚úèÔ∏è Edit
          </button>
        </div>
      </div>
    </div>

    <!-- Day Status Summary -->
    <div class="day-status-summary" *ngIf="todayData">
      <div class="status-header">
        <h3>Day Status</h3>
        <span class="completion-percentage">
          {{ getCompletionPercentage(todayData) }}% Complete
        </span>
      </div>
      
      <div class="status-details">
        <div class="status-item">
          <span class="status-label">Required Tasks:</span>
          <span class="status-value">
            {{ getRequiredTasksCompleted(todayData) }}/{{ getRequiredTasksTotal(todayData) }}
          </span>
        </div>
        
        <div class="status-item">
          <span class="status-label">Optional Tasks:</span>
          <span class="status-value">
            {{ getOptionalTasksCompleted(todayData) }}/{{ getOptionalTasksTotal(todayData) }}
          </span>
        </div>
        
        <div class="status-item" *ngIf="todayData.canUseGrace">
          <span class="status-label">Grace Available:</span>
          <span class="status-value grace-available">Yes</span>
        </div>
      </div>
      
      <!-- Recommendations -->
      <div class="recommendations" *ngIf="todayData.recommendations && todayData.recommendations.length > 0">
        <h4>Recommendations</h4>
        <div *ngFor="let recommendation of todayData.recommendations" class="recommendation-item">
          <span class="recommendation-icon">üí°</span>
          <span>{{ recommendation }}</span>
        </div>
      </div>
    </div>
    
  </div>

  <!-- Loading State -->
  <div class="loading-state" *ngIf="loading">
    <div class="loading-spinner"></div>
    <p>Loading your discipline calendar...</p>
  </div>

  <!-- Error State -->
  <div class="error-state" *ngIf="error">
    <div class="error-icon">‚ö†Ô∏è</div>
    <h3>Something went wrong</h3>
    <p>{{ error }}</p>
    <button class="retry-button" (click)="loadCurrentWeekData()">
      Try Again
    </button>
  </div>

  <!-- Add Ad Hoc Task Button -->
  <div class="add-task-section" *ngIf="isAnyToday()">
    <button class="add-task-btn" (click)="openAddTaskModal()">
      ‚ûï Add Quick Task
    </button>
  </div>
</div>

<!-- Debug Panel (for development) -->
<div class="debug-panel" *ngIf="false">
  <h4>Debug Info</h4>
  <pre>{{ { todayData, flexibleTasks, weeklyProgress } | json }}</pre>
</div>


<!-- Add Task Modal -->
<div class="modal-overlay" *ngIf="showAddTaskDialog" (click)="cancelAddTask()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Add Quick Task</h3>
      <button class="close-btn" (click)="cancelAddTask()">√ó</button>
    </div>
    
    <div class="modal-body">
      <div class="form-group">
        <label for="taskName">Task Name *</label>
        <input 
          type="text" 
          id="taskName"
          [(ngModel)]="newTaskName" 
          placeholder="Enter task name (e.g., 'Take out trash')"
          maxlength="100"
          class="form-input"
          #taskNameInput>
      </div>
      
      <div class="form-group">
        <label for="taskDescription">Description (optional)</label>
        <textarea 
          id="taskDescription"
          [(ngModel)]="newTaskDescription" 
          placeholder="Add any additional details..."
          maxlength="500"
          rows="3"
          class="form-textarea"></textarea>
      </div>
      
      <div class="error-message" *ngIf="errorMessage">
        {{ errorMessage }}
      </div>
    </div>
    
    <div class="modal-footer">
      <button class="cancel-btn" (click)="cancelAddTask()">Cancel</button>
      <button class="save-btn" (click)="addAdHocTask()" [disabled]="!newTaskName.trim()">
        Add Task
      </button>
    </div>
  </div>
</div>

<!-- Edit Task Modal -->
<div class="modal-overlay" *ngIf="showEditTaskDialog" (click)="cancelEditTask()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Edit Task</h3>
      <button class="close-btn" (click)="cancelEditTask()">√ó</button>
    </div>
    
    <div class="modal-body">
      <div class="form-group">
        <label for="editTaskName">Task Name *</label>
        <input 
          type="text" 
          id="editTaskName"
          [(ngModel)]="editTaskName" 
          placeholder="Enter task name"
          maxlength="100"
          class="form-input">
      </div>
      
      <div class="form-group">
        <label for="editTaskDescription">Description (optional)</label>
        <textarea 
          id="editTaskDescription"
          [(ngModel)]="editTaskDescription" 
          placeholder="Add any additional details..."
          maxlength="500"
          rows="3"
          class="form-textarea"></textarea>
      </div>
      
      <div class="error-message" *ngIf="errorMessage">
        {{ errorMessage }}
      </div>
    </div>
    
    <div class="modal-footer">
      <button class="cancel-btn" (click)="cancelEditTask()">Cancel</button>
      <button class="save-btn" (click)="saveEditedTask()" [disabled]="!editTaskName.trim()">
        Save Changes
      </button>
    </div>
  </div>
</div>