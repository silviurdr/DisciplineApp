<!-- habit-management.component.html -->
<div class="habit-management">
  <!-- Header -->
  <div class="header">
    <h2>Habit Management</h2>
    <button class="add-btn" (click)="openAddForm()" [disabled]="loading">
      ➕ Add New Habit
    </button>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-state">
    <div class="loading-spinner"></div>
    <p>Loading habits...</p>
  </div>

  <!-- Error Message -->
  <div *ngIf="error" class="error-message">
    <span class="error-icon">⚠️</span>
    {{ error }}
    <button class="retry-btn" (click)="loadHabits()">Retry</button>
  </div>

  <!-- Add/Edit Form -->
  <div class="form-overlay" *ngIf="showAddForm">
    <div class="habit-form">
      <div class="form-header">
        <h3>{{ editingHabit ? 'Edit Habit' : 'Add New Habit' }}</h3>
        <button class="close-btn" (click)="closeForm()">✕</button>
      </div>
      
      <form [formGroup]="habitForm" (ngSubmit)="saveHabit()">
        <!-- Basic Information -->
        <div class="form-section">
          <h4>Basic Information</h4>
          
          <div class="form-group">
            <label for="name">Habit Name *</label>
            <input 
              id="name"
              type="text" 
              formControlName="name"
              placeholder="e.g., Exercise, Read, Clean Kitchen"
              [class.error]="habitForm.get('name')?.touched && habitForm.get('name')?.errors">
            <div class="error-text" *ngIf="getFieldError('name')">{{ getFieldError('name') }}</div>
          </div>

          <div class="form-group">
            <label for="description">Description</label>
            <textarea 
              id="description"
              formControlName="description"
              placeholder="Describe what this habit involves..."
              rows="3"
              [class.error]="habitForm.get('description')?.touched && habitForm.get('description')?.errors"></textarea>
            <div class="error-text" *ngIf="getFieldError('description')">{{ getFieldError('description') }}</div>
          </div>
        </div>

        <!-- Frequency Configuration -->
        <div class="form-section">
          <h4>Frequency</h4>
          
          <div class="form-group">
            <label for="frequency">How often? *</label>
            <select id="frequency" formControlName="frequency">
              <option value="Daily">Daily</option>
              <option value="EveryTwoDays">Every 2 Days (Rolling)</option>
              <option value="Weekly">Weekly</option>
              <option value="Monthly">Monthly</option>
              <option value="Seasonal">Seasonal</option>
            </select>
          </div>

          <!-- Weekly Target -->
          <div class="form-group" *ngIf="shouldShowTargetField(habitForm.get('frequency')?.value, 'weekly')">
            <label for="weeklyTarget">Times per week</label>
            <input 
              id="weeklyTarget"
              type="number" 
              formControlName="weeklyTarget"
              min="1" 
              max="7"
              placeholder="e.g., 3">
            <div class="help-text">How many times per week should this habit be done?</div>
          </div>

          <!-- Monthly Target -->
          <div class="form-group" *ngIf="shouldShowTargetField(habitForm.get('frequency')?.value, 'monthly')">
            <label for="monthlyTarget">Times per month</label>
            <input 
              id="monthlyTarget"
              type="number" 
              formControlName="monthlyTarget"
              min="1" 
              max="31"
              placeholder="e.g., 2">
            <div class="help-text">How many times per month should this habit be done?</div>
          </div>

          <!-- Seasonal Target -->
          <div class="form-group" *ngIf="shouldShowTargetField(habitForm.get('frequency')?.value, 'seasonal')">
            <label for="seasonalTarget">Times per season</label>
            <input 
              id="seasonalTarget"
              type="number" 
              formControlName="seasonalTarget"
              min="1" 
              max="90"
              placeholder="e.g., 3">
            <div class="help-text">How many times per season (3 months) should this habit be done?</div>
          </div>
        </div>

        <!-- Deadline Configuration -->
        <div class="form-section">
          <h4>Deadline (Optional)</h4>
          
          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" formControlName="hasDeadline">
              Set daily deadline for this habit
            </label>
          </div>

          <div class="form-group" *ngIf="habitForm.get('hasDeadline')?.value">
            <label for="deadlineTime">Deadline Time</label>
            <input 
              id="deadlineTime"
              type="time" 
              formControlName="deadlineTime"
              placeholder="18:00">
            <div class="help-text">After this time, the habit will be marked as overdue</div>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button type="submit" class="save-btn" [disabled]="habitForm.invalid || loading">
            {{ editingHabit ? 'Update Habit' : 'Create Habit' }}
          </button>
          <button type="button" class="cancel-btn" (click)="closeForm()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Habits List -->
  <div class="habits-container" *ngIf="!loading">
    <!-- Daily Habits -->
    <div class="habit-category" *ngIf="getDailyHabits().length > 0">
      <h3>📅 Daily Habits</h3>
      <div class="habits-grid">
        <div *ngFor="let habit of getDailyHabits()" class="habit-card daily">
          <div class="habit-header">
            <h4>{{ habit.name }}</h4>
            <div class="habit-status">
              <span class="status-badge" [class.active]="habit.isActive">
                {{ habit.isActive ? 'Active' : 'Paused' }}
              </span>
              <span class="locked-badge" *ngIf="habit.isLocked">🔒</span>
            </div>
          </div>
          
          <p class="habit-description">{{ habit.description }}</p>
          
          <div class="habit-meta">
            <span class="frequency-badge">{{ getFrequencyDetails(habit) }}</span>
            <span class="deadline-badge" *ngIf="habit.hasDeadline">⏰ {{ habit.deadlineTime }}</span>
          </div>
          
          <div class="habit-actions">
            <button class="edit-btn" (click)="openEditForm(habit)">✏️ Edit</button>
            <button class="toggle-btn" 
                    [class.active]="habit.isActive"
                    (click)="toggleHabitActive(habit)">
              {{ habit.isActive ? '⏸️ Pause' : '▶️ Activate' }}
            </button>
            <button class="delete-btn" (click)="confirmDeleteHabit(habit)">🗑️ Delete</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Rolling Habits -->
    <div class="habit-category" *ngIf="getRollingHabits().length > 0">
      <h3>🔄 Rolling Habits</h3>
      <div class="habits-grid">
        <div *ngFor="let habit of getRollingHabits()" class="habit-card rolling">
          <div class="habit-header">
            <h4>{{ habit.name }}</h4>
            <div class="habit-status">
              <span class="status-badge" [class.active]="habit.isActive">
                {{ habit.isActive ? 'Active' : 'Paused' }}
              </span>
              <span class="locked-badge" *ngIf="habit.isLocked">🔒</span>
            </div>
          </div>
          
          <p class="habit-description">{{ habit.description }}</p>
          
          <div class="habit-meta">
            <span class="frequency-badge">{{ getFrequencyDetails(habit) }}</span>
            <span class="deadline-badge" *ngIf="habit.hasDeadline">⏰ {{ habit.deadlineTime }}</span>
          </div>
          
          <div class="habit-actions">
            <button class="edit-btn" (click)="openEditForm(habit)">✏️ Edit</button>
            <button class="toggle-btn" 
                    [class.active]="habit.isActive"
                    (click)="toggleHabitActive(habit)">
              {{ habit.isActive ? '⏸️ Pause' : '▶️ Activate' }}
            </button>
            <button class="delete-btn" (click)="confirmDeleteHabit(habit)">🗑️ Delete</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Weekly Habits -->
    <div class="habit-category" *ngIf="getWeeklyHabits().length > 0">
      <h3>📊 Weekly Habits</h3>
      <div class="habits-grid">
        <div *ngFor="let habit of getWeeklyHabits()" class="habit-card weekly">
          <div class="habit-header">
            <h4>{{ habit.name }}</h4>
            <div class="habit-status">
              <span class="status-badge" [class.active]="habit.isActive">
                {{ habit.isActive ? 'Active' : 'Paused' }}
              </span>
              <span class="locked-badge" *ngIf="habit.isLocked">🔒</span>
            </div>
          </div>
          
          <p class="habit-description">{{ habit.description }}</p>
          
          <div class="habit-meta">
            <span class="frequency-badge">{{ getFrequencyDetails(habit) }}</span>
            <span class="deadline-badge" *ngIf="habit.hasDeadline">⏰ {{ habit.deadlineTime }}</span>
          </div>
          
          <div class="habit-actions">
            <button class="edit-btn" (click)="openEditForm(habit)">✏️ Edit</button>
            <button class="toggle-btn" 
                    [class.active]="habit.isActive"
                    (click)="toggleHabitActive(habit)">
              {{ habit.isActive ? '⏸️ Pause' : '▶️ Activate' }}
            </button>
            <button class="delete-btn" (click)="confirmDeleteHabit(habit)">🗑️ Delete</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Monthly Habits -->
    <div class="habit-category" *ngIf="getMonthlyHabits().length > 0">
      <h3>📅 Monthly Habits</h3>
      <div class="habits-grid">
        <div *ngFor="let habit of getMonthlyHabits()" class="habit-card monthly">
          <div class="habit-header">
            <h4>{{ habit.name }}</h4>
            <div class="habit-status">
              <span class="status-badge" [class.active]="habit.isActive">
                {{ habit.isActive ? 'Active' : 'Paused' }}
              </span>
              <span class="locked-badge" *ngIf="habit.isLocked">🔒</span>
            </div>
          </div>
          
          <p class="habit-description">{{ habit.description }}</p>
          
          <div class="habit-meta">
            <span class="frequency-badge">{{ getFrequencyDetails(habit) }}</span>
            <span class="deadline-badge" *ngIf="habit.hasDeadline">⏰ {{ habit.deadlineTime }}</span>
          </div>
          
          <div class="habit-actions">
            <button class="edit-btn" (click)="openEditForm(habit)">✏️ Edit</button>
            <button class="toggle-btn" 
                    [class.active]="habit.isActive"
                    (click)="toggleHabitActive(habit)">
              {{ habit.isActive ? '⏸️ Pause' : '▶️ Activate' }}
            </button>
            <button class="delete-btn" (click)="confirmDeleteHabit(habit)">🗑️ Delete</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Seasonal Habits -->
    <div class="habit-category" *ngIf="getSeasonalHabits().length > 0">
      <h3>🌱 Seasonal Habits</h3>
      <div class="habits-grid">
        <div *ngFor="let habit of getSeasonalHabits()" class="habit-card seasonal">
          <div class="habit-header">
            <h4>{{ habit.name }}</h4>
            <div class="habit-status">
              <span class="status-badge" [class.active]="habit.isActive">
                {{ habit.isActive ? 'Active' : 'Paused' }}
              </span>
              <span class="locked-badge" *ngIf="habit.isLocked">🔒</span>
            </div>
          </div>
          
          <p class="habit-description">{{ habit.description }}</p>
          
          <div class="habit-meta">
            <span class="frequency-badge">{{ getFrequencyDetails(habit) }}</span>
            <span class="deadline-badge" *ngIf="habit.hasDeadline">⏰ {{ habit.deadlineTime }}</span>
          </div>
          
          <div class="habit-actions">
            <button class="edit-btn" (click)="openEditForm(habit)">✏️ Edit</button>
            <button class="toggle-btn" 
                    [class.active]="habit.isActive"
                    (click)="toggleHabitActive(habit)">
              {{ habit.isActive ? '⏸️ Pause' : '▶️ Activate' }}
            </button>
            <button class="delete-btn" (click)="confirmDeleteHabit(habit)">🗑️ Delete</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div class="empty-state" *ngIf="habits.length === 0 && !loading">
      <div class="empty-icon">📋</div>
      <h3>No habits yet</h3>
      <p>Create your first habit to start building better daily routines.</p>
      <button class="add-btn primary" (click)="openAddForm()">➕ Add Your First Habit</button>
    </div>
  </div>
</div>